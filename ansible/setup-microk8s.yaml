- name: Setup MicroK8s on Raspberry Pi workers (cgroups config)
  hosts: workers
  become: yes
  tasks:
      - name: Enable cgroups in boot config
        lineinfile:
            path: /boot/firmware/cmdline.txt
            regexp: "^(.*)$"
            line: '\1 cgroup_enable=memory cgroup_memory=1'
            backrefs: yes

      - name: Reboot to apply cgroups
        reboot:
            reboot_timeout: 300

- name: Install MicroK8s on all nodes
  hosts: cluster
  become: yes
  tasks:
      - name: Update apt cache (non-WSL)
        apt:
            update_cache: yes
        when: is_wsl is not defined or not is_wsl

      - name: Install MicroK8s
        snap:
            name: microk8s
            classic: yes
            channel: 1.28/stable

      - name: Add user to microk8s group
        user:
            name: "{{ ansible_user }}"
            groups: microk8s
            append: yes

      - name: Create .kube directory
        file:
            path: "/home/{{ ansible_user }}/.kube"
            state: directory
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
        become: no

      - name: Wait for MicroK8s to be ready
        shell: microk8s status --wait-ready
        become_user: "{{ ansible_user }}"
        retries: 5
        delay: 10
        register: result
        until: result.rc == 0

- name: Configure master node
  hosts: master
  become: yes
  tasks:
      - name: Generate join token
        shell: microk8s add-node --token-ttl 3600
        register: join_command
        become_user: "{{ ansible_user }}"

      - name: Save join command
        set_fact:
            join_token: "{{ join_command.stdout_lines | select('match', '.*microk8s join.*') | first }}"

      - name: Display join command
        debug:
            var: join_token
